<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Music DNA</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #121212; color: white; font-family: 'Circular Std', sans-serif; }
        .spotify-green { color: #1DB954; }
        .bg-spotify-green { background-color: #1DB954; }
        .card { background-color: #181818; transition: background-color 0.3s; }
        .card:hover { background-color: #282828; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        /* Animation */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Modal Animation */
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="p-6">

    <!-- LOGIN SECTION -->
    <div id="login-section" class="flex flex-col items-center justify-center h-screen hidden">
        <h1 class="text-5xl font-bold mb-8 tracking-tighter">ðŸŽ§ My Music DNA</h1>
        <div class="bg-[#181818] p-8 rounded-xl shadow-2xl w-full max-w-md text-center border border-[#282828]">
            <p class="text-gray-400 mb-6">Enter your Spotify Client ID to unlock your stats.</p>
            <input type="text" id="clientId" placeholder="Paste Client ID here" class="w-full p-3 mb-6 rounded bg-[#2a2a2a] text-white border border-[#333] focus:border-[#1DB954] outline-none transition">
            <button onclick="initiateLogin()" class="w-full bg-spotify-green text-black font-bold py-3 rounded-full hover:scale-105 transition transform shadow-lg">
                Log in with Spotify
            </button>
            <p class="text-xs text-gray-500 mt-6">
                Setup: Add <span id="current-url" class="text-gray-300 font-mono bg-black px-1 rounded"></span> to your Redirect URIs in the Spotify Dashboard.
            </p>
        </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboard-section" class="hidden max-w-7xl mx-auto fade-in">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-[#333] pb-6">
            <div class="flex items-center gap-6">
                <img id="user-img" src="https://i.scdn.co/image/ab6761610000e5eb55d39ab9c21d506aa72e5139" class="w-20 h-20 rounded-full shadow-lg border-2 border-[#1DB954] hidden object-cover">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Live Dashboard</p>
                    <h1 id="user-name-title" class="text-4xl md:text-6xl font-black tracking-tight">Your Music Profile</h1>
                </div>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <button onclick="fetchData('short_term')" class="time-btn px-6 py-2 rounded-full text-sm font-bold bg-[#333] hover:text-white text-gray-400 transition">Month</button>
                <button onclick="fetchData('medium_term')" class="time-btn px-6 py-2 rounded-full text-sm font-bold bg-white text-black transition shadow-lg">6 Months</button>
                <button onclick="fetchData('long_term')" class="time-btn px-6 py-2 rounded-full text-sm font-bold bg-[#333] hover:text-white text-gray-400 transition">All Time</button>
                <button onclick="logout()" class="ml-4 text-xs text-red-400 hover:text-red-300 font-bold uppercase tracking-widest">Logout</button>
            </div>
        </div>

        <!-- Metric Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="card p-6 rounded-xl text-center flex flex-col justify-center">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Obscurity</h3>
                <div id="obscurity-score" class="text-4xl font-black text-spotify-green">--</div>
                <p class="text-[10px] text-gray-500 mt-2">100 = Hipster</p>
            </div>
            <div class="card p-6 rounded-xl text-center flex flex-col justify-center">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Vibe</h3>
                <div id="vibe-check" class="text-2xl font-bold">--</div>
                <p id="vibe-desc" class="text-[10px] text-gray-500 mt-1">--</p>
            </div>
             <div class="card p-6 rounded-xl text-center flex flex-col justify-center">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Top Genre</h3>
                <div id="top-genre" class="text-lg font-bold capitalize leading-tight">--</div>
            </div>
            <div class="card p-6 rounded-xl text-center flex flex-col justify-center">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Era</h3>
                <div id="avg-year" class="text-3xl font-bold text-blue-400">--</div>
                <p class="text-[10px] text-gray-500 mt-2">Avg Release Year</p>
            </div>
            <div class="card p-6 rounded-xl text-center flex flex-col justify-center">
                <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Explicit %</h3>
                <div id="explicit-score" class="text-3xl font-bold text-red-400">--</div>
                <p class="text-[10px] text-gray-500 mt-2">Lyrical Content</p>
            </div>
        </div>

        <!-- Artist Gallery -->
        <div class="mb-8">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="w-2 h-8 bg-spotify-green rounded-full inline-block"></span>
                Your Headliners <span class="text-xs text-gray-500 font-normal ml-2">(Click for stats)</span>
            </h3>
            <div id="artists-gallery" class="flex gap-6 overflow-x-auto pb-4 scroll-smooth">
                <!-- Artist Circles Injected Here -->
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            
            <!-- Radar Chart -->
            <div class="card p-6 rounded-xl border border-[#282828]">
                <h3 class="font-bold mb-6 text-gray-300">Audio Signature</h3>
                <div class="relative h-72 w-full flex items-center justify-center">
                    <canvas id="radarChart"></canvas>
                </div>
                <p class="text-center text-xs text-gray-500 mt-4 italic">Shape indicates your taste profile</p>
            </div>

            <!-- Top Tracks List -->
            <div class="card p-6 rounded-xl border border-[#282828]">
                <h3 class="font-bold mb-4 text-gray-300">Top Tracks</h3>
                <div id="tracks-list" class="space-y-2 h-72 overflow-y-auto pr-2">
                    <!-- Tracks injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- ARTIST MODAL -->
    <div id="artist-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4 backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-[#181818] w-full max-w-2xl rounded-2xl shadow-2xl border border-[#333] overflow-hidden modal-enter" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="relative h-40 bg-gradient-to-b from-[#1DB954] to-[#181818] p-6 flex items-end">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl font-bold">&times;</button>
                <div class="flex items-end gap-4 translate-y-8">
                    <img id="modal-img" src="" class="w-32 h-32 rounded-full shadow-2xl border-4 border-[#181818] object-cover bg-[#282828]">
                    <div class="mb-2">
                        <h2 id="modal-name" class="text-3xl font-black text-white shadow-black drop-shadow-md">Artist Name</h2>
                        <p id="modal-followers" class="text-sm text-gray-300 font-mono">0 Followers</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal Content -->
            <div class="pt-12 p-6">
                <div class="flex gap-2 mb-6 flex-wrap" id="modal-genres">
                    <!-- Genres injected here -->
                </div>
                
                <h3 class="font-bold text-gray-300 mb-4 border-b border-[#333] pb-2">Popular Tracks</h3>
                <div id="modal-tracks" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Tracks injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const REDIRECT_URI = window.location.href.split('?')[0]; 
        const SCOPES = "user-top-read user-read-private";

        document.getElementById('current-url').textContent = REDIRECT_URI;

        // --- PKCE HELPERS ---
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // --- AUTH ---
        async function initiateLogin() {
            const clientId = document.getElementById('clientId').value;
            if (!clientId) return alert("Please enter a Client ID");
            
            localStorage.setItem('spotify_client_id', clientId);
            
            const codeVerifier = generateRandomString(128);
            localStorage.setItem('code_verifier', codeVerifier);
            
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateRandomString(16);

            const args = new URLSearchParams({
                response_type: 'code',
                client_id: clientId,
                scope: SCOPES,
                redirect_uri: REDIRECT_URI,
                state: state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });

            window.location = 'https://accounts.spotify.com/authorize?' + args;
        }

        async function handleTokenExchange(code) {
            const clientId = localStorage.getItem('spotify_client_id');
            const codeVerifier = localStorage.getItem('code_verifier');

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: REDIRECT_URI,
                client_id: clientId,
                code_verifier: codeVerifier
            });

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body
                });

                if (!response.ok) throw new Error("Token exchange failed");

                const data = await response.json();
                localStorage.setItem('access_token', data.access_token);
                window.history.replaceState({}, document.title, "/"); 
                showDashboard();
            } catch (e) {
                alert("Login failed. Check your Redirect URI in Spotify Dashboard.");
            }
        }

        // --- FETCHERS ---
        async function callSpotify(endpoint) {
            const token = localStorage.getItem('access_token');
            const res = await fetch(`https://api.spotify.com/v1/${endpoint}`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            if (res.status === 401) {
                logout(); // Token expired
                return null;
            }
            if (!res.ok) {
                console.error("Spotify API Error:", res.status, res.statusText);
                return null;
            }
            return res.json();
        }

        async function getUserProfile() {
            const profile = await callSpotify('me');
            if (profile) {
                const name = profile.display_name;
                document.getElementById('user-name-title').textContent = `${name}'s Profile`;
                document.title = `${name}'s Music DNA`; // Update Browser Tab Title
                
                if(profile.images.length > 0) {
                    const img = document.getElementById('user-img');
                    img.src = profile.images[0].url;
                    img.classList.remove('hidden');
                }
            }
        }

        async function fetchData(timeRange) {
            // UI Toggle
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-black');
                btn.classList.add('bg-[#333]', 'text-gray-400');
            });
            event.target.classList.remove('bg-[#333]', 'text-gray-400');
            event.target.classList.add('bg-white', 'text-black');

            // 1. TOP ARTISTS
            const artists = await callSpotify(`me/top/artists?limit=20&time_range=${timeRange}`);
            
            if (artists && artists.items) {
                const gallery = document.getElementById('artists-gallery');
                gallery.innerHTML = artists.items.map(a => `
                    <div onclick="openArtistModal('${a.id}')" class="flex flex-col items-center min-w-[100px] group cursor-pointer relative">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-full transition z-10"></div>
                        <img src="${a.images[0]?.url}" class="w-24 h-24 rounded-full object-cover shadow-lg group-hover:scale-105 transition border-2 border-transparent group-hover:border-[#1DB954]">
                        <p class="text-xs font-bold mt-3 text-center truncate w-24 group-hover:text-[#1DB954]">${a.name}</p>
                    </div>
                `).join('');

                // Metrics
                const avgPop = artists.items.reduce((sum, a) => sum + a.popularity, 0) / artists.items.length;
                document.getElementById('obscurity-score').textContent = Math.round(100 - avgPop);
                
                const genres = artists.items.flatMap(a => a.genres);
                const topGenre = genres.sort((a,b) => genres.filter(v => v===a).length - genres.filter(v => v===b).length).pop();
                document.getElementById('top-genre').textContent = topGenre || "N/A";
            }

            // 2. TOP TRACKS
            const tracks = await callSpotify(`me/top/tracks?limit=50&time_range=${timeRange}`);
            
            if (tracks && tracks.items && tracks.items.length > 0) {
                // List
                const list = document.getElementById('tracks-list');
                list.innerHTML = tracks.items.slice(0, 10).map((t, i) => `
                    <div class="flex items-center p-3 hover:bg-[#333] rounded-lg group transition">
                        <span class="text-[#1DB954] w-8 font-black text-lg">${i+1}</span>
                        <img src="${t.album.images[2]?.url || ''}" class="w-12 h-12 rounded shadow mr-4 bg-[#282828]">
                        <div class="overflow-hidden">
                            <div class="truncate font-bold text-white group-hover:text-[#1DB954] transition">${t.name}</div>
                            <div class="truncate text-xs text-gray-400">${t.artists[0].name}</div>
                        </div>
                    </div>
                `).join('');

                // NEW INSIGHTS
                const explicitCount = tracks.items.filter(t => t.explicit).length;
                const explicitPct = Math.round((explicitCount / tracks.items.length) * 100);
                document.getElementById('explicit-score').textContent = `${explicitPct}%`;

                const years = tracks.items.map(t => parseInt(t.album.release_date.substring(0, 4))).filter(y => !isNaN(y));
                const avgYear = years.length ? Math.round(years.reduce((a, b) => a + b, 0) / years.length) : "--";
                document.getElementById('avg-year').textContent = avgYear;

                // 3. AUDIO FEATURES
                const ids = tracks.items.map(t => t.id).join(',');
                if (ids) {
                    const features = await callSpotify(`audio-features?ids=${ids}`);
                    
                    if (features && features.audio_features) {
                        // Filter nulls (Fix for broken data)
                        const validFeatures = features.audio_features.filter(f => f !== null);
                        
                        if (validFeatures.length > 0) {
                            const avgs = { danceability:0, energy:0, valence:0, acousticness:0, speechiness:0 };
                            validFeatures.forEach(f => {
                                avgs.danceability += f.danceability;
                                avgs.energy += f.energy;
                                avgs.valence += f.valence;
                                avgs.acousticness += f.acousticness;
                                avgs.speechiness += f.speechiness;
                            });
                            const count = validFeatures.length;
                            
                            const valenceScore = avgs.valence / count;
                            const energyScore = avgs.energy / count;
                            let mood = "Chill â˜ï¸";
                            if (valenceScore > 0.6 && energyScore > 0.6) mood = "Party ðŸŽ‰";
                            else if (valenceScore < 0.4 && energyScore < 0.4) mood = "Melancholic ðŸŒ§ï¸";
                            else if (valenceScore > 0.6) mood = "Happy ðŸŒž";
                            else if (energyScore > 0.7) mood = "Intense ðŸ”¥";
                            
                            document.getElementById('vibe-check').textContent = mood;
                            document.getElementById('vibe-desc').textContent = `${Math.round(valenceScore * 100)}% Positivity`;

                            renderChart([
                                avgs.danceability/count, avgs.energy/count, avgs.valence/count, 
                                avgs.acousticness/count, avgs.speechiness/count
                            ]);
                        }
                    }
                }
            } else {
                console.warn("No tracks found");
                document.getElementById('vibe-check').textContent = "No Data";
                document.getElementById('tracks-list').innerHTML = "<p class='text-gray-500 p-4'>No top tracks found for this period.</p>";
            }
        }

        // --- MODAL LOGIC ---
        async function openArtistModal(artistId) {
            const modal = document.getElementById('artist-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // 1. Get Artist Details
            const artist = await callSpotify(`artists/${artistId}`);
            if(artist) {
                document.getElementById('modal-name').textContent = artist.name;
                document.getElementById('modal-followers').textContent = `${artist.followers.total.toLocaleString()} Followers`;
                document.getElementById('modal-img').src = artist.images[0]?.url || '';
                
                const genresDiv = document.getElementById('modal-genres');
                genresDiv.innerHTML = artist.genres.map(g => 
                    `<span class="px-3 py-1 bg-[#333] rounded-full text-xs font-bold text-gray-300 capitalize border border-[#444]">${g}</span>`
                ).join('');
            }

            // 2. Get Top Tracks (Market=US required)
            const tracks = await callSpotify(`artists/${artistId}/top-tracks?market=US`);
            if(tracks && tracks.tracks) {
                const trackDiv = document.getElementById('modal-tracks');
                trackDiv.innerHTML = tracks.tracks.slice(0, 10).map((t, i) => `
                    <div class="flex items-center justify-between p-2 hover:bg-[#333] rounded group">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="text-gray-500 font-mono w-4 text-center">${i+1}</span>
                            <img src="${t.album.images[2]?.url}" class="w-10 h-10 rounded">
                            <div class="truncate">
                                <p class="text-sm font-bold text-white group-hover:text-[#1DB954] transition">${t.name}</p>
                                <p class="text-[10px] text-gray-400">${t.album.name}</p>
                            </div>
                        </div>
                        <div class="text-xs font-bold text-gray-500">${t.popularity}%</div>
                    </div>
                `).join('');
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return; // Only close if clicking backdrop or close button
            const modal = document.getElementById('artist-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- CHART ---
        let myChart = null;
        function renderChart(data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Dance', 'Energy', 'Happy', 'Acoustic', 'Words'],
                    datasets: [{
                        label: 'Stats',
                        data: data,
                        backgroundColor: 'rgba(29, 185, 84, 0.5)',
                        borderColor: '#1DB954',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#1DB954'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#333' },
                            grid: { color: '#333' },
                            pointLabels: { color: '#aaa', font: { size: 11, family: 'Circular Std' } },
                            ticks: { display: false, backdropColor: 'transparent' },
                            suggestedMin: 0,
                            suggestedMax: 1
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            getUserProfile(); 
            fetchData('medium_term');
        }

        function logout() {
            localStorage.removeItem('access_token');
            location.reload();
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                handleTokenExchange(code);
            } else if (localStorage.getItem('access_token')) {
                showDashboard();
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                if(localStorage.getItem('spotify_client_id')) {
                    document.getElementById('clientId').value = localStorage.getItem('spotify_client_id');
                }
            }
        };
    </script>
</body>
</html>
